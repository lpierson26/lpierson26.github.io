<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spin to Win — Locker Room Legends</title>
  <style>
    /* Insert Design System CSS Here */
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .photo img { width: 100%; max-width: 320px; height: 180px; object-fit: contain; display: block; border-radius: 12px; margin: 10px auto; }
    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    @media(max-width: 900px) { .grid3 { grid-template-columns: 1fr; } }
    .hidden { display: none; }
    input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; font-size: 14px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <header style="background: var(--white); border-bottom: 1px solid var(--border);">
    <div class="brandBar"></div>
    <div style="max-width: 1100px; margin: auto; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <a href="index.html"><img src="logo.webp" alt="Locker Room Legends" style="height: 60px;"></a>
        <div>
          <div style="font-weight: 900;">Spin to Win</div>
          <div style="font-size: 12px; color: var(--muted);">Venmo Only. Sign up → Pay.</div>
        </div>
      </div>
      <span id="globalStatus" class="pill">Loading…</span>
    </div>
  </header>

  <main class="wrap">
    <section id="pagePick" class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h2 style="margin: 0;">Pick a Spin</h2>
          <p style="margin: 0; color: var(--muted); font-size: 14px;">Choose an available raffle below.</p>
        </div>
      </div>
      <div id="spinCards" class="grid3"></div>
    </section>

    <section id="pageSignup" class="card hidden">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 id="signupTitle" style="margin: 0;">Sign Up</h2>
        <button id="btnBack" class="secondary">← Back</button>
      </div>
      <div id="signupDesc" style="margin: 10px 0; color: var(--muted);"></div>
      <div style="display: flex; gap: 10px; margin: 15px 0;">
        <span id="signupPrice" class="pill blue">$0</span>
        <span id="signupFill" class="pill">0/0 filled</span>
        <span id="signupStatus" class="pill">Open</span>
      </div>
      <div class="progressWrap"><div id="signupBar" class="bar"></div></div>
      <div id="signupPhotoWrap"></div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
        <div><label>Name</label><input id="name" placeholder="Full Name"></div>
        <div><label>Phone</label><input id="phone" placeholder="(###) ###-####"></div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>Email</label><input id="email" placeholder="email@example.com"></div>
        <div><label>Venmo</label><input id="venmo" placeholder="@username"></div>
      </div>
      <label>Pick your wheel number (1–24)</label>
      <select id="spinNumber"><option value="">Loading...</option></select>
      
      <button id="btnSubmit" style="width: 100%; margin-top: 10px;">Submit Entry</button>
      <div id="msg" class="pill hidden" style="width: 100%; text-align: center; margin-top: 15px; padding: 15px; border-radius: 12px;"></div>
    </section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzKySmUQWZMOBe0KIKk5mTA_XrM-5g41duDkO9Ic9jC6MgeOClObz78ZRrx-gSyPDW6Pg/exec";
    let state = { spins: [], selectedSpinKey: null };

    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
    function num(v){ const n=Number(v); return isFinite(n)?n:0; }
    function resolvePhotoUrl(p){
      p=String(p||"").trim(); if(!p) return "";
      if(p.includes("drive.google.com")){
        const id = p.match(/id=([^&]+)/) || p.match(/\/d\/([^/]+)/);
        return id ? `https://drive.google.com/uc?export=view&id=${id[1]}` : p;
      }
      if(p.includes("github.com/blob/")) return p.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
      return p;
    }

    async function refresh() {
      const res = await fetch(`${API_URL}?ts=${Date.now()}`);
      const data = await res.json();
      state.spins = data.spins || [];
      renderPick();
    }

    function renderPick() {
      const grid = document.getElementById("spinCards");
      grid.innerHTML = "";
      state.spins.forEach(s => {
        const left = num(s.capacity) - num(s.signedUp);
        const open = left > 0 && (s.status || "OPEN").toUpperCase() === "OPEN";
        const pct = s.capacity > 0 ? (s.signedUp / s.capacity) * 100 : 0;
        const img = resolvePhotoUrl(s.imageUrl || s.photo);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="font-weight: 800;">${escapeHtml(s.title)}</div>
          <div style="font-size: 13px; color: var(--muted); height: 40px; overflow: hidden;">${escapeHtml(s.desc)}</div>
          <div style="margin: 10px 0;"><span class="pill blue">$${s.price}</span></div>
          ${img ? `<div class="photo"><img src="${img}"></div>` : ""}
          <div class="progressWrap"><div class="bar" style="width: ${pct}%"></div></div>
          <button style="width: 100%; margin-top: 15px;" ${open ? "" : "disabled"} onclick="goSignup('${s.spinID}')">${open ? 'Enter Spin' : 'Sold Out'}</button>
        `;
        grid.appendChild(card);
      });
      document.getElementById("globalStatus").textContent = state.spins.some(s => num(s.capacity) > num(s.signedUp)) ? "Spins Available" : "All Full";
    }

    window.goSignup = (key) => {
      state.selectedSpinKey = key;
      const s = state.spins.find(x => x.spinID == key);
      document.getElementById("pagePick").classList.add("hidden");
      document.getElementById("pageSignup").classList.remove("hidden");
      document.getElementById("signupTitle").textContent = `Sign Up: ${s.title}`;
      document.getElementById("signupDesc").textContent = s.desc;
      document.getElementById("signupPrice").textContent = `$${s.price} Entry`;
      document.getElementById("signupFill").textContent = `${s.signedUp}/${s.capacity} Filled`;
      document.getElementById("signupBar").style.width = `${(s.signedUp/s.capacity)*100}%`;
      
      const select = document.getElementById("spinNumber");
      select.innerHTML = '<option value="">Select a number...</option>';
      const taken = new Set((s.takenNumbers || []).map(Number));
      for(let i=1; i<=24; i++) {
        const opt = document.createElement("option");
        opt.value = i; opt.textContent = taken.has(i) ? `${i} (Taken)` : i;
        if(taken.has(i)) opt.disabled = true;
        select.appendChild(opt);
      }
    };

    document.getElementById("btnBack").onclick = () => {
      document.getElementById("pageSignup").classList.add("hidden");
      document.getElementById("pagePick").classList.remove("hidden");
    };

    document.getElementById("btnSubmit").onclick = async () => {
      const btn = document.getElementById("btnSubmit");
      const m = document.getElementById("msg");
      const email = document.getElementById("email").value;
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alert("Invalid Email");
      
      btn.disabled = true; btn.textContent = "Submitting...";
      const payload = {
        spinId: state.selectedSpinKey,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        email: email,
        venmo: document.getElementById("venmo").value,
        spinNumber: document.getElementById("spinNumber").value
      };
      
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        const data = await res.json();
        if(data.ok) {
          m.innerHTML = "<strong>Success!</strong> Pay via Venmo now."; m.className = "pill good"; m.classList.remove("hidden");
          setTimeout(() => location.reload(), 3000);
        } else { throw new Error(data.error); }
      } catch(e) { alert(e.message); btn.disabled = false; btn.textContent = "Submit Entry"; }
    };

    refresh();
  </script>
</body>
</html>
