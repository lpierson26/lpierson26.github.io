<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Locker Room Legends — Storefront</title>
  <style>
    /* Insert Design System CSS Here */
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .photo img { width: 100%; height: 200px; object-fit: contain; border-radius: 8px; }
    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    @media(max-width: 800px) { .grid3 { grid-template-columns: 1fr; } }
    input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <header style="background: var(--white); border-bottom: 1px solid var(--border);">
    <div class="brandBar"></div>
    <div style="max-width: 1100px; margin: auto; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
      <a href="index.html"><img src="logo.webp" alt="Locker Room Legends" style="height: 60px;"></a>
      <span id="statusPill" class="pill">Loading…</span>
    </div>
  </header>

  <main class="wrap">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h1 style="margin: 0;">Storefront</h1>
      <button class="secondary" onclick="refresh()">Refresh Items</button>
    </div>
    <div id="itemsGrid" class="grid3"></div>
  </main>

  <div id="modalOverlay" class="modalOverlay">
    <div class="modal">
      <h2 id="mTitle" style="margin-top: 0;">Reserve Item</h2>
      <p id="mSub" style="color: var(--muted);"></p>
      <label>Name</label><input id="buyerName" placeholder="Your Name">
      <label>Phone</label><input id="buyerPhone" placeholder="(###) ###-####">
      <label>Email</label><input id="buyerEmail" placeholder="you@email.com">
      <label>Venmo</label><input id="buyerVenmo" placeholder="@username">
      <button id="mSubmit" style="width: 100%;">Reserve Item</button>
      <button class="secondary" style="width: 100%; margin-top: 10px;" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwBDRTeFsCZuFMOkj8AvPm37ZPqfxQ_BLjPW6u5yxYvNEtGHmDrG4fBU8ap05yGkpK2/exec";
    let state = { items: [], selected: null };

    function resolvePhotoUrl(p){
      p=String(p||"").trim(); if(!p) return "";
      if(p.includes("drive.google.com")){
        const id = p.match(/id=([^&]+)/) || p.match(/\/d\/([^/]+)/);
        return id ? `https://drive.google.com/uc?export=view&id=${id[1]}` : p;
      }
      return p;
    }

    async function refresh() {
      const res = await fetch(`${API_URL}?ts=${Date.now()}`);
      const data = await res.json();
      state.items = data.items || [];
      render();
    }

    function render() {
      const grid = document.getElementById("itemsGrid");
      grid.innerHTML = "";
      state.items.forEach(it => {
        const id = it.id || it.itemId;
        const open = it.status === "OPEN";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="photo"><img src="${resolvePhotoUrl(it.imageUrl || it.photo)}"></div>
          <div style="font-weight: 800; margin: 10px 0;">${it.title}</div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="pill blue">$${it.price}</span>
            <span class="pill ${open ? 'good' : 'bad'}">${it.status}</span>
          </div>
          <button style="width: 100%; margin-top: 15px;" ${open ? "" : "disabled"} onclick="openModal('${id}')">${open ? 'Reserve' : 'Unavailable'}</button>
        `;
        grid.appendChild(card);
      });
      document.getElementById("statusPill").textContent = `${state.items.filter(x=>x.status==="OPEN").length} Available`;
    }

    window.openModal = (id) => {
      state.selected = state.items.find(x => (x.id || x.itemId) == id);
      document.getElementById("mTitle").textContent = `Reserve: ${state.selected.title}`;
      document.getElementById("mSub").textContent = `Price: $${state.selected.price}`;
      document.getElementById("modalOverlay").classList.add("show");
    };

    window.closeModal = () => document.getElementById("modalOverlay").classList.remove("show");

    document.getElementById("mSubmit").onclick = async () => {
      const payload = { action: "reserve", itemId: state.selected.id || state.selected.itemId, name: document.getElementById("buyerName").value, email: document.getElementById("buyerEmail").value, phone: document.getElementById("buyerPhone").value, venmo: document.getElementById("buyerVenmo").value };
      await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      location.reload();
    };

    refresh();
  </script>
</body>
</html>
